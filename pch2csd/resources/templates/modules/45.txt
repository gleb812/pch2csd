;@ ins a k a
;@ outs a

opcode FltVoice,0,kkkkkkkkkkkkkk
; TODO check transition function. now it is just linear
kSel1,kSel2,kSel3,kLevel,kForm,kFormM,kFreq,kFreqM,kRes,kOn, kIn,kModIn,kFModIn,kOut xin
ain zar kIn
afmod zar kFModIn
kfmod = k(afmod)
kmod zkr kModIn
kLevel /= 127

iQ[] init 128
iQ fillarray 7,7.2,7.4,7.5,7.7,7.9,8,8.2,8.4,8.6,8.8,9,9.2,9.4,9.6,9.8,10,10.2,10.5,10.7,10.9,11.2,11.4,11.6,11.8,12,12.2,12.4,
12.6,12.8,13,13.2,13.4,13.6,13.8,14.1,14.3,14.5,14.7,15,15.2,16.2,16.6,17.1,17.5,18,18.5,19,19.5,20.1,20.6,21.2,21.8,
22.4,23,23.6,24.2,24.9,25.6,26.3,27,27.7,28.5,29.3,30,31,32,33,34,36,37,38,39,40,42,43,44,46,47,49,50,52,55,57,60,62,
65,68,71,75,78,82,85,89,93,98,102,105,112,118,125,133,141,149,158,167,177,188,199,220,244,271,301,334,371,411,456,506,
562,624,692,796,924,1073,1246,1446,1679,1949

iF1[][] init 9,128
iF1 fillarray 98,100,103,106,110,113,116,119,123,127,130,134,138,142,146,151,155,160,164,169,174,179,185,190,196,201,207,213,220,226,
233,240,247,254,261,269,277,285,294,302,311,320,330,339,349,360,370,381,392,404,416,428,441,453,467,481,495,509,524,540,
556,572,589,606,624,642,661,681,701,721,742,764,787,810,834,858,884,910,936,964,992,1021,1051,1082,1114,1147,1181,1216,
1251,1288,1326,1365,1405,1447,1489,1533,1578,1624,1672,1722,1772,1824,1878,1933,1990,2049,2109,2171,2235,2301,2368,2438,
2510,2584,2660,2738,2818,2901,2987,3075,3165,3258,3354,3453,3554,3659,3767,3878,
54,56,57,59,61,62,64,66,68,70,72,74,77,79,81,84,86,88,91,94,97,99,102,105,108,112,115,118,122,125,129,133,137,141,145,149,
154,158,163,167,172,177,183,188,194,199,205,211,217,224,230,237,244,251,259,266,274,282,291,299,308,317,326,336,346,356,366,
377,388,400,412,424,436,449,462,476,490,504,519,534,550,566,583,600,618,636,655,674,694,714,735,757,779,802,825,850,875,900,
927,954,982,1011,1041,1072,1103,1136,1169,1203,1239,1275,1313,1351,1391,1432,1474,1518,1562,1608,1656,1704,1754,1806,1859,1914,1970,2028,2088,2149,
43,45,46,47,49,50,52,53,55,56,58,60,61,63,65,67,69,71,73,75,77,80,82,84,87,90,92,95,98,101,103,107,110,113,116,120,123,127,
130,134,138,142,147,151,155,160,165,169,174,180,185,190,196,202,208,214,220,226,233,240,247,254,262,269,277,286,294,303,311,
321,330,340,350,360,371,382,393,404,416,429,441,454,467,481,495,510,525,540,556,573,590,607,625,643,662,682,702,722,743,765,
788,811,835,859,885,911,938,965,994,1023,1053,1084,1116,1149,1182,1217,1253,1290,1328,1367,1407,1449,1491,1535,1580,1627,1675,1724,
50,51,53,54,56,58,59,61,63,65,67,69,71,73,75,77,79,82,84,87,89,92,95,97,100,103,106,109,112,116,119,123,126,130,134,138,
142,146,150,155,159,164,169,174,179,184,190,195,201,207,213,219,226,232,239,246,253,261,268,276,284,293,301,310,319,329,
339,348,359,369,380,391,403,415,427,439,452,466,479,494,508,523,538,554,571,587,605,622,641,660,679,699,720,741,763,785,
808,832,856,881,907,934,962,990,1019,1049,1080,1112,1144,1178,1213,1248,1285,1323,1362,1402,1443,1486,1529,1574,1621,1668,1717,1768,1820,1874,1929,1985,
50,51,53,54,56,57,59,61,63,65,66,68,70,72,75,77,79,81,84,86,89,91,94,97,100,103,106,109,112,115,119,122,126,129,133,137,141,
145,150,154,159,163,168,173,178,183,189,194,200,206,212,218,224,231,238,245,252,260,267,275,283,291,300,309,318,327,337,347,
357,368,378,389,401,413,425,437,450,463,477,491,506,521,536,552,568,585,602,619,638,656,676,696,716,737,759,781,804,828,852,
877,903,930,957,985,1014,1044,1075,1106,1139,1172,1207,1242,1279,1317,1355,1395,1436,1479,1522,1567,1613,1660,1709,1760,1811,1865,1919,1976,
41,42,43,44,45,47,48,50,51,53,54,56,57,59,61,63,64,66,68,70,72,74,77,79,81,84,86,89,91,94,97,100,102,105,109,112,115,118,
122,125,129,133,137,141,145,149,154,158,163,168,173,178,183,188,194,200,205,212,218,224,231,238,245,252,259,267,275,283,
291,300,308,317,327,336,346,356,367,378,389,400,412,424,437,450,463,476,490,505,520,535,551,567,584,601,619,637,655,675,
695,715,736,758,780,803,827,851,876,902,928,956,984,1013,1042,1073,1105,1137,1171,1205,1241,1277,1315,1353,1393,1434,1476,1520,1564,1611,
62,64,66,68,70,72,74,76,79,81,83,86,88,91,94,96,99,102,105,108,111,115,118,122,125,129,133,137,141,145,149,153,158,162,167,
172,177,182,188,193,199,205,211,217,224,230,237,244,251,258,266,274,282,290,299,308,317,326,335,345,356,366,377,388,399,
411,423,436,448,462,475,489,503,518,534,549,565,582,599,617,635,654,673,693,713,734,756,778,801,824,849,874,899,926,953,981,
1010,1040,1070,1102,1134,1167,1202,1237,1274,1311,1350,1389,1430,1472,1516,1560,1606,1653,1702,1752,1804,1857,1911,1968,2025,2085,2146,2210,2275,2342,2410,2481,
123,126,130,134,138,142,146,150,155,159,164,169,174,179,184,189,195,201,207,213,219,225,232,239,246,253,261,268,276,284,293,
301,310,319,329,338,348,358,369,380,391,403,414,427,439,452,465,479,493,508,523,538,554,570,587,604,622,640,659,679,698,719,
740,762,784,807,831,856,881,907,933,961,989,1018,1048,1079,1111,1144,1177,1212,1248,1284,1322,1361,1401,1442,1485,1528,1573,
1620,1667,1716,1767,1819,1872,1927,1984,2042,2103,2164,2228,2294,2361,2431,2502,2576,2652,2730,2810,2893,2978,3065,3156,3248,
3344,3442,3544,3648,3755,3866,3980,4097,4217,4341,4469,4601,4736,4875,
73,75,77,79,82,84,86,89,92,94,97,100,103,106,109,112,116,119,122,126,130,134,138,142,146,150,154,159,164,168,173,179,184,189,
195,200,206,212,219,225,232,239,246,253,260,268,276,284,292,301,310,319,328,338,348,358,369,379,391,402,414,426,439,452,465,
478,493,507,522,537,553,569,586,603,621,639,658,678,698,718,739,761,783,806,830,855,880,906,932,960,988,1017,1047,1078,1109,
1142,1176,1210,1246,1283,1320,1359,1399,1440,1483,1526,1571,1618,1665,1714,1765,1816,1870,1925,1982,2040,2100,2162,2225,2291,2358,2428,2499,2573,2648,2726,2806,2889

iF2[][] init 9,128
iF2 fillarray 140,144,148,153,157,162,166,171,176,182,187,192,198,204,210,216,223,229,236,243,250,257,265,273,281,289,297,306,315,324,334,
344,354,364,375,386,397,409,421,434,446,459,473,487,501,516,531,547,563,579,596,614,632,651,670,689,710,731,752,774,797,821,845,870,
895,921,949,976,1005,1035,1065,1097,1129,1162,1196,1231,1268,1305,1343,1383,1424,1465,1509,1553,1599,1646,1694,1744,1795,1848,1903,
1958,2016,2075,2137,2199,2264,2331,2399,2470,2543,2617,2694,2774,2855,2939,3026,3115,3206,3301,3398,3498,3601,3707,3816,3928,4044,
4163,4285,4411,4541,4675,4812,4954,5100,5250,5404,5563,
347,357,368,379,390,401,413,425,438,451,464,478,492,506,521,536,552,568,585,602,620,638,657,676,696,717,738,760,782,805,829,853,878,
904,930,958,986,1015,1045,1076,1107,1140,1173,1208,1244,1280,1318,1357,1396,1438,1480,1523,1568,1614,1662,1711,1761,1813,1866,1921,
1978,2036,2096,2157,2221,2286,2354,2423,2494,2568,2643,2721,2801,2883,2968,3056,3145,3238,3333,3431,3532,3636,3743,3853,3967,4083,4204,
4327,4455,4586,4721,4860,5003,5150,5301,5457,5618,5783,5953,6128,6309,6494,6686,6882,7085,7293,7508,7729,7956,8190,8431,8679,8935,9198,
9468,9747,10034,10329,10633,10946,11268,11599,11941,12292,12654,13026,13409,13804,
377,389,400,412,424,436,449,462,476,490,504,519,534,550,566,583,600,618,636,655,674,694,714,735,757,779,802,826,850,875,901,927,955,983,
1012,1041,1072,1104,1136,1169,1204,1239,1276,1313,1352,1392,1433,1475,1518,1563,1609,1656,1705,1755,1807,1860,1915,1971,2029,2089,2150,
2213,2279,2346,2415,2486,2559,2634,2712,2791,2874,2958,3045,3135,3227,3322,3420,3520,3624,3731,3840,3953,4070,4189,4313,4440,4570,4705,
4843,4986,5132,5283,5439,5599,5764,5933,6108,6287,6472,6663,6859,7061,7269,7482,7703,7929,8162,8403,8650,8904,9166,9436,9714,10000,10294,
10597,10909,11230,11560,11900,12250,12611,12982,13364,13757,14162,14579,15008,
103,106,109,112,115,119,122,126,129,133,137,141,145,149,154,158,163,168,173,178,183,189,194,200,206,212,218,224,231,238,245,252,259,267,
275,283,291,300,309,318,327,337,347,357,367,378,389,401,412,425,437,450,463,477,491,505,520,535,551,567,584,601,619,637,656,675,695,716,
737,758,781,804,827,852,877,902,929,956,985,1013,1043,1074,1106,1138,1172,1206,1242,1278,1316,1354,1394,1435,1478,1521,1566,1612,1659,1708,
1758,1810,1863,1918,1975,2033,2093,2154,2218,2283,2350,2419,2490,2564,2639,2717,2797,2879,2964,3051,3141,3233,3328,3426,3527,3631,3737,3847,3961,4077,
260,268,276,284,292,301,309,319,328,338,347,358,368,379,390,402,414,426,438,451,464,478,492,507,521,537,553,569,586,603,621,639,658,677,
697,717,739,760,783,806,829,854,879,905,931,959,987,1016,1046,1077,1108,1141,1175,1209,1245,1281,1319,1358,1398,1439,1481,1525,1570,1616,
1664,1712,1763,1815,1868,1923,1980,2038,2098,2160,2223,2289,2356,2425,2497,2570,2646,2724,2804,2886,2971,3059,3149,3241,3337,3435,3536,3640,
3747,3857,3971,4087,4208,4332,4459,4590,4725,4864,5007,5155,5306,5463,5623,5789,5959,6134,6315,6501,6692,6889,7092,7300,7515,7736,7964,8198,
8440,8688,8943,9207,9478,9756,10044,10339,
318,327,337,347,357,367,378,389,401,413,425,437,450,463,477,491,506,520,536,551,568,584,602,619,638,656,676,695,716,737,759,781,804,828,852,
877,903,929,957,985,1014,1044,1074,1106,1139,1172,1207,1242,1279,1316,1355,1395,1436,1478,1522,1566,1613,1660,1709,1759,1811,1864,1919,1976,
2034,2093,2155,2218,2284,2351,2420,2491,2565,2640,2718,2798,2880,2965,3052,3142,3234,3330,3427,3528,3632,3739,3849,3962,4079,4199,4322,4450,
4581,4715,4854,4997,5144,5295,5451,5612,5777,5947,6122,6302,6487,6678,6875,7077,7285,7499,7720,7947,8181,8422,8670,8925,9187,9458,9736,10022,
10317,10621,10933,11255,11586,11927,12278,12639,
109,112,115,118,122,125,129,133,137,141,145,149,154,158,163,168,173,178,183,188,194,200,205,211,218,224,231,237,244,252,259,267,274,283,291,
299,308,317,327,336,346,356,367,378,389,400,412,424,437,449,463,476,490,505,520,535,551,567,583,601,618,636,655,674,694,715,736,757,780,803,
826,851,876,901,928,955,983,1012,1042,1073,1104,1137,1170,1205,1240,1277,1314,1353,1393,1434,1476,1519,1564,1610,1657,1706,1756,1808,1861,
1916,1972,2030,2090,2152,2215,2280,2347,2416,2487,2560,2636,2713,2793,2875,2960,3047,3137,3229,3324,3422,3523,3626,3733,3843,3956,4072,4192,4315,
267,275,283,291,300,308,317,327,336,346,357,367,378,389,400,412,424,437,450,463,476,490,505,520,535,551,567,584,601,619,637,655,675,695,
715,736,758,780,803,827,851,876,902,928,956,984,1013,1043,1073,1105,1137,1171,1205,1241,1277,1315,1353,1393,1434,1476,1520,1565,1611,
1658,1707,1757,1809,1862,1917,1973,2031,2091,2153,2216,2281,2348,2417,2488,2562,2637,2715,2794,2877,2961,3048,3138,3230,3326,3423,3524,
3628,3735,3844,3958,4074,4194,4317,4444,4575,4710,4848,4991,5138,5289,5445,5605,5770,5940,6114,6294,6479,6670,6866,7068,7276,7490,7711,
7938,8171,8412,8659,8914,9176,9446,9724,10010,10305,10608,
253,260,268,276,284,292,301,309,318,328,338,347,358,368,379,390,402,413,426,438,451,464,478,492,507,521,537,553,569,586,603,621,639,658,
677,697,717,738,760,783,806,829,854,879,905,931,959,987,1016,1046,1077,1108,1141,1175,1209,1245,1281,1319,1358,1398,1439,1481,1525,1570,
1616,1663,1712,1763,1815,1868,1923,1980,2038,2098,2159,2223,2288,2356,2425,2496,2570,2645,2723,2803,2886,2971,3058,3148,3241,3336,3434,
3535,3640,3747,3857,3970,4087,4207,4331,4459,4590,4725,4864,5007,5154,5306,5462,5623,5788,5959,6134,6315,6500,6692,6889,7091,7300,7515,
7736,7963,8198,8439,8687,8943,9206,9477,9756,10043

iF3[][] init 9,128
iF3 fillarray 379,390,401,413,425,438,451,464,478,492,506,521,536,552,568,585,602,620,638,657,676,696,717,738,760,782,805,829,853,878,904,930,958,986,
1015,1045,1076,1107,1140,1173,1208,1244,1280,1318,1357,1396,1438,1480,1523,1568,1614,1662,1711,1761,1813,1866,1921,1978,2036,2096,2158,
2221,2286,2354,2423,2494,2568,2643,2721,2801,2883,2968,3056,3145,3238,3333,3431,3532,3636,3743,3853,3967,4084,4204,4327,4455,4586,4721,4860,
5003,5150,5301,5457,5618,5783,5953,6129,6309,6495,6686,6882,7085,7293,7508,7729,7956,8190,8431,8679,8935,9198,9468,9747,10034,10329,10633,
10946,11268,11600,11941,12292,12654,13026,13409,13804,14210,14628,15059,
441,454,467,481,495,510,525,540,556,572,589,607,624,643,662,681,701,722,743,765,787,811,834,859,884,910,937,965,993,1022,1052,1083,1115,
1148,1182,1216,1252,1289,1327,1366,1406,1448,1490,1534,1579,1626,1674,1723,1774,1826,1879,1935,1992,2050,2111,2173,2237,2302,2370,2440,
2512,2586,2662,2740,2821,2904,2989,3077,3168,3261,3357,3456,3557,3662,3770,3881,3995,4112,4233,4358,4486,4618,4754,4894,5038,5186,5339,
5496,5657,5824,5995,6172,6353,6540,6733,6931,7135,7345,7561,7783,8012,8248,8491,8741,8998,9262,9535,9816,10104,10402,10708,11023,11347,
11681,12025,12379,12743,13118,13504,13901,14310,14731,15165,15611,16070,16543,17030,17531,
556,573,589,607,625,643,662,681,701,722,743,765,788,811,835,859,885,911,937,965,993,1023,1053,1084,1116,1148,1182,1217,1253,1290,1328,1367,
1407,1448,1491,1535,1580,1626,1674,1724,1774,1826,1880,1936,1992,2051,2111,2174,2238,2303,2371,2441,2513,2587,2663,2741,2822,2905,2990,3078,
3169,3262,3358,3457,3559,3663,3771,3882,3996,4114,4235,4360,4488,4620,4756,4896,5040,5188,5341,5498,5660,5826,5998,6174,6356,6543,6735,6934,
7138,7348,7564,7786,8015,8251,8494,8744,9001,9266,9539,9820,10108,10406,10712,11027,11352,11686,12030,12384,12748,13123,13509,13907,14316,
14737,15171,15617,16077,16550,17037,17538,18054,18585,19132,19695,20275,20871,21485,22118,
382,389,401,412,425,437,450,463,477,491,505,520,535,551,567,584,601,619,637,656,675,695,716,737,758,781,804,827,852,877,902,929,956,985,1013,
1043,1074,1106,1138,1172,1206,1242,1278,1316,1354,1394,1435,1478,1521,1566,1612,1659,1708,1758,1810,1863,1918,1975,2033,2093,2154,2218,2283,
2350,2419,2490,2564,2639,2717,2797,2879,2964,3051,3141,3233,3328,3426,3527,3631,3737,3847,3961,4077,4197,4321,4448,4579,4713,4852,4995,5142,
5293,5449,5609,5774,5944,6119,6299,6484,6675,6872,7074,7282,7496,7717,7944,8178,8418,8666,8921,9183,9454,9732,10018,10313,10616,10929,11250,
11581,11922,12403,12634,13006,13389,13783,14188,14606,15035,
357,367,378,389,401,412,425,437,450,463,477,491,505,520,535,551,567,584,601,619,637,656,675,695,716,737,758,781,804,827,852,877,902,929,956,
984,1013,1043,1074,1106,1138,1172,1206,1242,1278,1316,1354,1394,1435,1477,1521,1566,1612,1659,1708,1758,1810,1863,1918,1975,2033,2092,2154,
2217,2283,2350,2419,2490,2563,2639,2716,2796,2879,2963,3051,3140,3233,3328,3426,3527,3630,3737,3847,3960,4077,4197,4320,4447,4578,4713,4852,
4994,5141,5293,5448,5609,5774,5944,6119,6299,6484,6675,6871,7073,7281,7496,7716,7943,8177,8418,8665,8920,9183,9453,9731,10018,10312,10616,
10928,11250,11581,11921,12272,12633,13005,13388,13782,14187,
413,426,438,451,464,478,492,506,521,537,553,569,585,603,620,639,658,677,697,717,738,760,782,806,829,854,879,905,931,959,987,1016,1046,1076,
1108,1141,1174,1209,1244,1281,1319,1358,1398,1439,1481,1525,1569,1616,1663,1712,1762,1814,1868,1923,1979,2037,2097,2159,2223,2288,2355,2425,
2496,2569,2645,2723,2803,2886,2970,3058,3148,3240,3336,3434,3535,3639,3746,3856,3970,4087,4207,4331,4458,4589,4724,4863,5006,5154,5305,5461,
5622,5788,5958,6133,6314,6499,6691,6888,7090,7299,7514,7735,7962,8197,8438,8686,8942,9205,9475,9754,10041,10337,10641,10954,11276,11608,11950,
12301,12663,13036,13419,13814,14221,14639,15070,15513,15970,16440,
379,390,401,413,425,438,451,464,477,491,506,521,536,552,568,585,602,620,638,657,676,696,717,738,759,782,805,828,853,878,904,930,958,986,1015,
1045,1075,1107,1140,1173,1208,1243,1280,1317,1356,1396,1437,1479,1523,1568,1614,1661,1710,1761,1812,1866,1921,1977,2035,2095,2157,2220,2286,
2353,2422,2494,2567,2642,2720,2800,2883,2967,3055,3145,3237,3332,3430,3531,3635,3742,3852,3966,4082,4203,4326,4454,4585,4719,4858,5001,5148,
5300,5456,5616,5782,5952,6127,6307,6493,6684,6881,7083,7291,7506,7727,7954,8188,8429,8677,8933,9195,9466,9744,10031,10326,10630,10943,11265,
11596,11938,12289,12651,13023,13406,13800,14206,14625,15055,
390,401,413,425,438,451,464,478,492,506,521,537,552,569,585,603,620,639,657,677,697,717,738,760,782,805,829,853,878,904,931,958,986,1016,1045,
1076,1108,1140,1174,1209,1244,1281,1318,1357,1397,1438,1481,1524,1569,1615,1663,1712,1762,1814,1867,1922,1979,2037,2097,2158,2222,2287,2355,
2424,2495,2569,2644,2722,2802,2885,2969,3057,3147,3239,3335,3433,3534,3638,3745,3855,3969,4085,4205,4329,4457,4588,4723,4862,5005,5152,5304,
5460,5620,5786,5956,6131,6312,6497,6689,6885,7088,7296,7511,7732,7960,8194,8435,8683,8939,9202,9472,9751,10038,10334,10638,10951,11273,11604,
11946,12297,12659,13032,13415,13810,14216,14635,15065,15509,
367,378,389,401,412,425,437,450,463,477,491,505,520,536,551,567,584,601,619,637,656,675,695,716,737,758,781,804,827,852,877,903,929,956,985,
1014,1043,1074,1106,1138,1172,1206,1242,1278,1316,1355,1394,1435,1478,1521,1566,1612,1659,1708,1759,1810,1864,1918,1975,2033,2093,2154,2218,
2283,2350,2419,2490,2564,2639,2717,2797,2879,2964,3051,3141,3233,3328,3426,3527,3631,3738,3848,3961,4077,4197,4321,4448,4579,4714,4852,4995,
5142,5293,5449,5610,5775,5945,6119,6300,6485,6676,6872,7074,7283,7497,7717,7944,8178,8419,8667,8922,9184,9454,9733,10019,10314,10617,10930,
11251,11582,11923,12274,12635,13007,13390,13784,14189,14607

; form and freq mod
kForm += kFormM*kmod
kForm limit kForm,0,127
kFreq += kFreqM*kfmod
kFreq limit kFreq,0,127
if kForm > 64 then
;linear interp
kF1 = (iF1[kSel2][kFreq]+iF1[kSel3][kFreq])*.5
kF2 = (iF2[kSel2][kFreq]+iF2[kSel3][kFreq])*.5
kF3 = (iF3[kSel2][kFreq]+iF3[kSel3][kFreq])*.5
else
kF1 = (iF1[kSel2][kFreq]+iF1[kSel1][kFreq])*.5
kF2 = (iF2[kSel2][kFreq]+iF2[kSel1][kFreq])*.5
kF3 = (iF3[kSel2][kFreq]+iF3[kSel1][kFreq])*.5
endif

alow,ahigh,a1 svfilter ain, kF1, iQ[kRes]
alow,ahigh,a2 svfilter ain, kF2, iQ[kRes]
alow,ahigh,a3 svfilter ain, kF3, iQ[kRes]

aout = a1 + a2 + a3
zaw aout*kLevel*kOn,kOut
endop
